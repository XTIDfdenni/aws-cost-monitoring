language: generic

branches:
  except: # skip release tags
    - /^v?\d+\.\d+(\.\d+)?(-\S*)?$/

_shared_job: &SHARED_JOB
  install:
    - curl --silent --output terraform.zip https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_${TF_OS}.zip
    - sha256sum terraform.zip  | grep ${TF_SHA256}
    - unzip terraform.zip ; rm -f terraform.zip; chmod +x terraform
    - mkdir -p ${HOME}/bin ; export PATH=${PATH}:${HOME}/bin; mv terraform ${HOME}/bin/
    - terraform -v
  script:
    - terraform fmt -check -diff aws-budget/
    - terraform fmt -check -diff datadog-budget/
    - terraform init tests/
    - terraform validate tests/

jobs:
  include:
    - stage: Validate
      env:
        - TF_VERSION=0.12.24
        - TF_OS=linux_amd64
        - TF_SHA256=602d2529aafdaa0f605c06adb7c72cfb585d8aa19b3f4d8d189b42589e27bf11
      <<: *SHARED_JOB
    # - env:
    #     - TF_VERSION=0.12.23
    #     - TF_OS=linux_amd64
    #     - TF_SHA256=78fd53c0fffd657ee0ab5decac604b0dea2e6c0d4199a9f27db53f081d831a45
    #   <<: *SHARED_JOB
    - stage: Release
      if: branch = master AND (type = push OR type = api)
      language: node
      node_js: 12
      install: ignore
      script: ignore
      env:
        - secure: "PrCnSPV5QDJxeojUuFwueqMikU3v1HWUQhGWuxnKkt1kYvySNTbyUZcihRcX9CuWed1Q9hPc3SpfPGGmWwuPPsdPWIEY0GxniyNEc7IVeIGZT4PwlY8+q6+swRW36S1vvyXYi1YCIEwulahEnYTJcEPRYoCaSdGR54qA4zmyx8cfGFwsAcujKt8sfTIrLjt6rBD0NQm8/LmgwhPKhmEwzb/vJ8pIHAf3ew4wzyT/wEuQdwI+BFPMgVPvOhAcKc5NNjfRt2p0C29zsVdUDhZf2+a10Ta6P5xUUSRVdYNHXY8w9Y9xEu2PNDxclbpMgF6qNj/F3C5RMjXJTOnIeB91UdWKHR9kAIQsrW653FZfvndwotOTVQJhQ7tPijkI9Mn0Xwe944Mtnb8mA/OWNNWT3Aa16sNA+u6/VFNr9S4Cuwe/S/0Bin8VM4hm3yrs+cNTMJMz3yszUc7CEVViFTr612H5jBSg7bTvibeEV7a/VC6DEhAmvgJ5W51fdfGmRPHGaKGjOltE1XPNYmdx8yNdTum0BCvJ8JsCmxapiwBAr5XudVZZouVhNmslpqM8W9Q71ZBwOX4uQPHGvpUKO6BKLKYRxsdzviz0b0UAMVFNELesFwCD+9ZJKqSvG7VT22txlw/eFW7gg5VkCsaMA21ni/FgcGTIQEWDlbTxgidUE6g="
      deploy:
        - provider: script
          script: npx semantic-release
